<UserControl x:Class="Veriflow.Desktop.Views.PlayerView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:local="clr-namespace:Veriflow.Desktop.Views"
             xmlns:vm="clr-namespace:Veriflow.Desktop.ViewModels"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="800">
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="Auto"/> <!-- Transport Top -->
            <RowDefinition Height="*"/>    <!-- Tracks -->
        </Grid.RowDefinitions>

        <!-- Header -->
        <materialDesign:Card Grid.Row="0" Margin="0,0,0,20" Padding="15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel Grid.Column="0" VerticalAlignment="Center">
                    <TextBlock Text="DERUSH / CONSOLE" Style="{StaticResource MaterialDesignOverlineTextBlock}"/>
                    <TextBlock Text="{Binding FileName, TargetNullValue='Aucun fichier chargé'}" Style="{StaticResource MaterialDesignHeadline5TextBlock}"/>
                    <TextBlock Text="{Binding FilePath}" Style="{StaticResource MaterialDesignCaptionTextBlock}" Opacity="0.5" TextTrimming="CharacterEllipsis"/>
                    
                    <!-- Timecode Display Big -->
                    <StackPanel Orientation="Horizontal" Margin="0,10,0,0">
                         <TextBlock Text="{Binding CurrentTimeDisplay}" Style="{StaticResource MaterialDesignHeadline4TextBlock}" Foreground="{DynamicResource PrimaryHueLightBrush}"/>
                         <TextBlock Text=" / " Style="{StaticResource MaterialDesignHeadline4TextBlock}" Opacity="0.5"/>
                         <TextBlock Text="{Binding TotalTimeDisplay}" Style="{StaticResource MaterialDesignHeadline4TextBlock}" Opacity="0.5"/>
                    </StackPanel>
                </StackPanel>
                <Button Grid.Column="1" Command="{Binding LoadFileCommand}" Content="OUVRIR MÉDIA" Style="{StaticResource MaterialDesignOutlinedButton}" VerticalAlignment="Top"/>
            </Grid>
        </materialDesign:Card>

        <!-- Transport Controls -->
        <Border Grid.Row="1" Background="{DynamicResource MaterialDesignPaper}" Margin="0,0,0,10" Padding="10" CornerRadius="4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Command="{Binding StopCommand}" Style="{StaticResource MaterialDesignFloatingActionMiniButton}" Margin="0,0,10,0" Background="IndianRed" BorderBrush="IndianRed" ToolTip="Stop (Num 0)">
                        <materialDesign:PackIcon Kind="Square" Width="16" Height="16"/>
                    </Button>
                    <Button Command="{Binding PlayCommand}" Style="{StaticResource MaterialDesignFloatingActionButton}" Margin="0,0,10,0" Height="50" Width="50" ToolTip="Play (Space)">
                        <materialDesign:PackIcon Kind="Play" Width="28" Height="28"/>
                    </Button>
                    <Button Command="{Binding PauseCommand}" Style="{StaticResource MaterialDesignFloatingActionMiniButton}" Background="Orange" BorderBrush="Orange" ToolTip="Pause (P)">
                         <materialDesign:PackIcon Kind="Pause" Width="16" Height="16"/>
                    </Button>
                </StackPanel>
                
                <Slider Grid.Column="1" Minimum="0" Maximum="{Binding PlaybackMaximum}" Value="{Binding PlaybackPosition}" Margin="20,0,0,0" VerticalAlignment="Center" IsEnabled="True"/> 
            </Grid>
        </Border>

        <!-- Tracks List (DAW View) -->
        <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
            <ItemsControl ItemsSource="{Binding Tracks}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation="Vertical"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type vm:TrackViewModel}">
                        <Border Background="{DynamicResource MaterialDesignPaper}" Margin="0,0,0,5" Padding="5" CornerRadius="2">
                            <Grid Height="60">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="80"/> <!-- Name -->
                                    <ColumnDefinition Width="100"/> <!-- Controls -->
                                    <ColumnDefinition Width="*"/>   <!-- Waveform -->
                                </Grid.ColumnDefinitions>

                                <!-- Track Name -->
                                <Border Grid.Column="0" Background="#22FFFFFF" CornerRadius="2" Margin="0,0,5,0">
                                    <TextBlock Text="{Binding TrackName}" VerticalAlignment="Center" HorizontalAlignment="Center" FontWeight="Bold" Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                                </Border>

                                <!-- Controls (Solo/Mute/Vol) -->
                                <Grid Grid.Column="1" Margin="0,0,10,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <ToggleButton Grid.Column="0" Grid.Row="0" Command="{Binding ToggleMuteCommand}" IsChecked="{Binding IsMuted}" Style="{StaticResource MaterialDesignActionToggleButton}" Height="25" Width="25" Margin="2" ToolTip="Mute"
                                                  Content="{materialDesign:PackIcon Kind=VolumeOff}"
                                                  materialDesign:ToggleButtonAssist.OnContent="{materialDesign:PackIcon Kind=VolumeMute}"/>

                                    <ToggleButton Grid.Column="1" Grid.Row="0" Command="{Binding ToggleSoloCommand}" IsChecked="{Binding IsSoloed}" Style="{StaticResource MaterialDesignActionToggleButton}" Height="25" Width="25" Margin="2" Background="Goldenrod" BorderBrush="Transparent" ToolTip="Solo"
                                                  Content="S" materialDesign:ToggleButtonAssist.OnContent="S"/>
                                    
                                    <!-- Simple Volume Slider Horizontal for compactness -->
                                    <Slider Grid.Row="1" Grid.ColumnSpan="2" Minimum="0" Maximum="1" Value="{Binding Volume}" Margin="0,5,0,0" Orientation="Horizontal"/>
                                </Grid>

                                <!-- Waveform -->
                                <Border Grid.Column="2" Background="#11FFFFFF" ClipToBounds="True">
                                    <Polygon Points="{Binding WaveformPoints}" Fill="{DynamicResource SecondaryHueMidBrush}" Stretch="Fill" Height="40" VerticalAlignment="Center"/>
                                </Border>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
    </Grid>
</UserControl>
